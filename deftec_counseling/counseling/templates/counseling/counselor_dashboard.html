{% extends 'counseling/base.html' %}
{% block content %}

<style>
body {
    font-family: "Inter", "Segoe UI", sans-serif;
    background: linear-gradient(135deg, #f2f5fa, #e4ebf3);
}

.dashboard-container {
    max-width: 1300px;
    margin: 30px auto;
    padding: 20px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logout-btn {
    background: #dc3545;
    color: #fff;
    padding: 8px 18px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
}

.counselor-header {
    background: rgba(255,255,255,0.95);
    border-radius: 18px;
    padding: 25px;
    margin: 25px 0;
    box-shadow: 0 12px 35px rgba(0,0,0,.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-btn {
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    border: none;
    cursor: pointer;
}

.online { background:#28a745; color:#fff; }
.offline { background:#6c757d; color:#fff; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background:#fff;
    padding:20px;
    border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,.07);
    text-align:center;
}

.stat-card h3 { margin:0; font-size:28px; color:#1d3557; }
.stat-card p { margin:5px 0 0; color:#555; }

.appointments-grid {
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(300px,1fr));
    gap:20px;
}

.appointment-card {
    background:#fff;
    padding:22px;
    border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,.07);
    border-left:6px solid #0d6efd;
}

.badge {
    padding:6px 14px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
    color:#fff;
}

.pending { background:#ffc107; color:#000; }
.approved { background:#28a745; }
.completed { background:#0d6efd; }
.cancelled { background:#dc3545; }

.call-btn {
    padding:8px 14px;
    border-radius:8px;
    border:none;
    font-size:13px;
    margin-right:5px;
    color:#fff;
    text-decoration:none;
    display:inline-block;
    margin-bottom:6px;
}

.voice { background:#0d6efd; }
.video { background:#6f42c1; }
.chat { background:#198754; }

.missed-call {
    background:#fff3cd;
    padding:15px;
    border-radius:12px;
    margin-bottom:10px;
}

.book-upload-form input[type="text"],
.book-upload-form input[type="file"] {
    padding:8px;
    margin-right:10px;
    border-radius:6px;
    border:1px solid #ccc;
}

.book-upload-form button {
    background:#0d6efd;
    color:#fff;
    padding:8px 16px;
    border:none;
    border-radius:8px;
    font-weight:600;
    cursor:pointer;
}
</style>

<div class="dashboard-container">

    <!-- TOP BAR -->
    <div class="top-bar">
        <h2>Counselor Dashboard</h2>
        <form method="POST" action="{% url 'logout' %}">
            {% csrf_token %}
            <button class="logout-btn">Logout</button>
        </form>
    </div>

    <!-- HEADER -->
    <div class="counselor-header">
        <h3>Welcome, {{ request.user.first_name }} {{ request.user.last_name }}</h3>
        <div>
            {% if status.is_online %}
                <span class="status-btn online">Online</span>
            {% else %}
                <span class="status-btn offline">Offline</span>
            {% endif %}
            <a href="{% url 'update_status' 'online' %}" class="status-btn online">Go Online</a>
            <a href="{% url 'update_status' 'offline' %}" class="status-btn offline">Go Offline</a>
        </div>
    </div>

    <!-- ANALYTICS -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ total_appointments }}</h3>
            <p>Total Appointments</p>
        </div>
        <div class="stat-card">
            <h3>{{ pending_count }}</h3>
            <p>Pending</p>
        </div>
        <div class="stat-card">
            <h3>{{ completed_count }}</h3>
            <p>Completed</p>
        </div>
        <div class="stat-card">
            <h3>{{ missed_calls.count }}</h3>
            <p>Missed Calls</p>
        </div>
    </div>

    <!-- MISSED CALLS -->
    {% if missed_calls %}
        <h4>Missed Calls</h4>
        {% for call in missed_calls %}
            <div class="missed-call">
                Missed {{ call.call_type }} call from {{ call.caller.first_name }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- APPOINTMENTS -->
    <h4>Your Appointments</h4>
    <div id="appointments-list" class="appointments-grid">
        {% for appt in appointments %}
        <div class="appointment-card" data-id="{{ appt.id }}">
            <strong>{{ appt.student.first_name }} {{ appt.student.last_name }}</strong><br>
            {{ appt.date }} | {{ appt.time }}<br>
            {{ appt.specialization.name }}<br><br>

            <span class="badge {{ appt.status|lower }}">{{ appt.status }}</span><br><br>

            <a href="{% url 'start_call' appt.student.id 'voice' %}?appointment_id={{ appt.id }}"
               class="call-btn voice">Voice Call</a>
            <a href="{% url 'start_call' appt.student.id 'video' %}?appointment_id={{ appt.id }}"
               class="call-btn video">Video Call</a>
            <a href="{% url 'appointment_detail' appt.id %}"
               class="call-btn" style="background:#1d3557;">ðŸ’¬ Chat</a>
        </div>
        {% empty %}
            <p>No appointments assigned yet.</p>
        {% endfor %}
    </div>

    <!-- BOOK UPLOAD (Counselor Only) -->
    {% if request.user.role == 'counselor' %}
    <h4>Upload Books for Students</h4>
    <form method="POST" enctype="multipart/form-data" class="book-upload-form" action="{% url 'upload_book' %}">
        {% csrf_token %}
        <input type="text" name="title" placeholder="Book Title" required>
        <input type="file" name="file" accept=".pdf,.doc,.docx" required>
        <button type="submit">Upload</button>
    </form>
    {% endif %}

    <!-- AVAILABLE BOOKS -->
    <h4>Available Books</h4>
    <div class="appointments-grid">
        {% for book in books %}
            <div class="appointment-card">
                <strong>{{ book.title }}</strong><br>
                Uploaded by: {{ book.uploaded_by.first_name }}<br>
                <a href="{{ book.file.url }}" download class="call-btn chat">Download</a>
            </div>
        {% empty %}
            <p>No books uploaded yet.</p>
        {% endfor %}
    </div>

</div>

<!-- AJAX Script to update appointments live -->
<script>
function renderAppointmentCard(appt) {
    const card = document.createElement('div');
    card.className = 'appointment-card';
    card.setAttribute('data-id', appt.id);
    card.innerHTML = `
        <strong>${appt.student_name}</strong><br>
        ${appt.date} | ${appt.time}<br>
        ${appt.specialization}<br><br>
        <span class="badge ${appt.status.toLowerCase()}">${appt.status}</span><br><br>
        <a href="/start_call/${appt.id}/voice?appointment_id=${appt.id}" class="call-btn voice">Voice Call</a>
        <a href="/start_call/${appt.id}/video?appointment_id=${appt.id}" class="call-btn video">Video Call</a>
        <a href="/appointment_detail/${appt.id}" class="call-btn" style="background:#1d3557;">ðŸ’¬ Chat</a>
    `;
    return card;
}

function loadAppointments() {
    fetch("{% url 'counselor_appointments_ajax' %}")
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('appointments-list');
            container.innerHTML = '';
            if(data.length === 0){
                container.innerHTML = '<p>No appointments assigned yet.</p>';
                return;
            }
            data.forEach(appt => {
                container.appendChild(renderAppointmentCard(appt));
            });
        })
        .catch(err => console.error(err));
}

// Initial load
loadAppointments();

// Poll every 10 seconds
setInterval(loadAppointments, 10000);
</script>

{% endblock %}